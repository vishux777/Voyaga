{% extends 'base.html' %}
{% block title %}Property â€” Voyaga{% endblock %}
{% block content %}
<div class="page-container" style="max-width:1100px;">
  <div id="propLoading" style="text-align:center;padding:4rem;"><div class="spinner"></div></div>
  <div id="propContent" class="hidden"></div>
</div>
<div class="lightbox hidden" id="lightbox" onclick="closeLightbox()">
  <button class="lb-close" onclick="closeLightbox()">âœ•</button>
  <button class="lb-prev" onclick="lbNav(-1,event)">â€¹</button>
  <img id="lightboxImg" src="" alt="">
  <button class="lb-next" onclick="lbNav(1,event)">â€º</button>
</div>
{% endblock %}
{% block scripts %}
<script>
const propId = window.location.pathname.split('/').filter(Boolean).pop();
let propData = null, lbImages = [], lbIndex = 0, blockedDates = [], selectedRating = 0, guestCount = 2, selectedCrypto = 'btc';

async function loadProperty() {
  let data;
  try {
    const r = await fetch(`/api/properties/${propId}/`);
    data = await r.json();
  } catch(e) { data = null; }
  if (!data || data.detail) {
    document.getElementById('propLoading').innerHTML = '<div style="color:var(--text2);padding:4rem;text-align:center;">Property not found.</div>';
    return;
  }
  propData = data;
  renderProperty(data);
  loadBlockedDates();
  if (getToken()) checkWishlist();
}

async function loadBlockedDates() {
  try {
    const r = await fetch(`/api/bookings/availability/${propId}/`);
    const d = await r.json();
    blockedDates = d.blocked_dates || [];
  } catch(e) { blockedDates = []; }
  renderCalendar();
}

async function checkWishlist() {
  const res = await api(`/api/bookings/wishlist/${propId}/check/`, 'GET', null, true);
  if (res) updateHeartBtn(res.wishlisted);
}

function renderProperty(p) {
  document.title = `${p.title} â€” Voyaga`;
  const images = p.images || [];
  lbImages = images.map(i => i.image_url);
  const amIcons = { wifi:'ğŸ“¶',pool:'ğŸŠ',gym:'ğŸ’ª',parking:'ğŸš—',kitchen:'ğŸ³',ac:'â„ï¸',heating:'ğŸ”¥',tv:'ğŸ“º',washer:'ğŸ§º',balcony:'ğŸŒ…' };
  const amenHtml = (p.amenities||[]).length
    ? p.amenities.map(a=>`<span class="amenity-chip">${amIcons[a]||'âœ“'} ${a}</span>`).join('')
    : '<span style="color:var(--text2);font-size:0.85rem;">No amenities listed</span>';
  const carbon = calcCarbon(p);
  document.getElementById('propLoading').classList.add('hidden');
  const el = document.getElementById('propContent');
  el.classList.remove('hidden');
  el.innerHTML = `
    <div class="prop-gallery">
      <div class="gallery-main" onclick="openLightbox(0)">
        ${images[0]?`<img src="${images[0].image_url}" alt="${p.title}">`:'<div class="no-img-lg">ğŸ </div>'}
      </div>
      ${images.length>1?`<div class="gallery-grid">${images.slice(1,5).map((img,i)=>`
        <div class="gallery-thumb" onclick="openLightbox(${i+1})">
          <img src="${img.image_url}" alt="">
          ${i===3&&images.length>5?`<div class="more-overlay">+${images.length-5}</div>`:''}
        </div>`).join('')}</div>`:''}
    </div>
    <div class="prop-layout">
      <div class="prop-left">
        <div class="prop-header-row">
          <div>
            <div class="prop-type-badge">${p.property_type}</div>
            <h1 class="prop-title">${p.title}</h1>
            <div class="prop-meta-row">
              <span>ğŸ“ ${p.city}, ${p.country}</span>
              ${p.avg_rating?`<span>â˜… ${p.avg_rating} (${p.review_count} reviews)</span>`:'<span>âœ¦ New listing</span>'}
              <span>ğŸ‘¤ ${p.host_name}</span>
            </div>
          </div>
          <button class="heart-btn" id="heartBtn" onclick="toggleWishlist()">â™¡</button>
        </div>
        <div class="prop-specs-row">
          <div class="spec-item">ğŸ‘¥ ${p.max_guests} guests</div>
          <div class="spec-item">ğŸ› ${p.bedrooms} bed</div>
          <div class="spec-item">ğŸš¿ ${p.bathrooms} bath</div>
          <div class="spec-item">ğŸ  ${p.property_type}</div>
        </div>
        <div class="prop-section"><h3>About this place</h3><p style="color:var(--text2);line-height:1.75;font-size:0.92rem;">${p.description}</p></div>
        <div class="prop-section"><h3>Amenities</h3><div class="amenities-wrap">${amenHtml}</div></div>
        <div class="prop-section">
          <h3>ğŸŒ± Carbon Footprint</h3>
          <div class="carbon-box">
            <div class="carbon-rating carbon-${carbon.rating.toLowerCase()}">${carbon.rating} Environmental Impact</div>
            <div class="carbon-stats">
              <div class="carbon-stat"><span>ğŸŒ¿</span><strong>${carbon.co2}kg</strong><span>COâ‚‚/night</span></div>
              <div class="carbon-stat"><span>âš¡</span><strong>${carbon.energy}kWh</strong><span>energy/night</span></div>
              <div class="carbon-stat"><span>ğŸ’§</span><strong>${carbon.water}L</strong><span>water/night</span></div>
            </div>
          </div>
        </div>
        <div class="prop-section">
          <h3>ğŸ“… Availability Calendar</h3>
          <p style="font-size:0.78rem;color:var(--text2);margin-bottom:0.75rem;">Red = already booked. Green = available.</p>
          <div id="calendarWrap"></div>
        </div>
        <div class="prop-section">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
            <h3 style="margin:0;">â˜… Reviews${p.review_count?` (${p.review_count})`:''}</h3>
            ${getToken()?'<button class="btn-sm" onclick="toggleReviewForm()">Write Review</button>':''}
          </div>
          <div id="reviewFormWrap" class="hidden" style="background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:1.2rem;margin-bottom:1.5rem;">
            <div id="starPicker">${[1,2,3,4,5].map(n=>`<span onclick="setRating(${n})" style="font-size:1.6rem;cursor:pointer;color:var(--text2);">â˜†</span>`).join('')}</div>
            <textarea id="reviewComment" rows="3" placeholder="Share your experience..." style="width:100%;margin-top:0.75rem;resize:vertical;"></textarea>
            <button class="btn-primary" style="margin-top:0.75rem;width:100%;" onclick="submitReview()">Submit Review</button>
          </div>
          <div id="reviewsList"><div style="color:var(--text2);font-size:0.85rem;text-align:center;padding:1.5rem;">Loading...</div></div>
        </div>
      </div>
      <div class="prop-right">
        <div class="booking-card">
          <div class="booking-price">$${parseFloat(p.price_per_night).toFixed(0)}<span class="booking-price-night">/night</span></div>
          <div class="date-inputs">
            <div class="date-inp-group"><label>CHECK-IN</label><input type="date" id="checkIn" onchange="updateCalc()"></div>
            <div class="date-inp-group"><label>CHECK-OUT</label><input type="date" id="checkOut" onchange="updateCalc()"></div>
          </div>
          <div class="guests-row">
            <label style="font-size:0.72rem;color:var(--text2);text-transform:uppercase;">Guests</label>
            <div class="guests-counter">
              <button onclick="changeGuests(-1)" type="button">âˆ’</button>
              <span id="guestCount">2</span>
              <button onclick="changeGuests(1)" type="button">+</button>
            </div>
          </div>
          <div id="availStatus" style="font-size:0.8rem;margin:6px 0;min-height:18px;"></div>
          <div id="bookSummary" class="hidden">
            <div class="b-line"><span id="nightsLbl"></span><span id="nightsTot"></span></div>
            <div class="b-line" style="color:#2ecc71;font-size:0.76rem;" id="carbonLbl"></div>
            <div class="b-line" style="color:var(--gold);font-size:0.76rem;" id="pointsLbl"></div>
            <hr style="border-color:var(--border);margin:10px 0;">
            <div class="b-line" style="font-weight:700;font-size:1rem;"><span>Total</span><span id="bookTotal"></span></div>
          </div>
          <div id="cryptoSel" class="hidden" style="margin:0.8rem 0;">
            <div style="font-size:0.7rem;color:var(--text2);text-transform:uppercase;margin-bottom:6px;">Pay with crypto</div>
            <div class="crypto-pills-row">
              ${['btc','eth','usdt','sol','ltc','bnb','doge'].map((c,i)=>`
                <button class="cpill ${i===0?'active':''}" onclick="pickCrypto('${c}',this)">${c.toUpperCase()}</button>`).join('')}
            </div>
          </div>
          <button class="btn-primary w-full" id="bookBtn" onclick="initiateBooking(${p.id})">Reserve Now</button>
          <p style="text-align:center;font-size:0.73rem;color:var(--text2);margin-top:6px;">You won't be charged yet</p>
        </div>
      </div>
    </div>`;
  loadReviews();
}

// â”€â”€ CALENDAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let calY, calM;
function renderCalendar(dy=0, dm=0) {
  const now = new Date();
  if (!calY) { calY=now.getFullYear(); calM=now.getMonth(); }
  calM += dm;
  while(calM<0){calM+=12;calY--;}
  while(calM>11){calM-=12;calY++;}
  const wrap = document.getElementById('calendarWrap');
  if(!wrap) return;
  const first = new Date(calY,calM,1).getDay();
  const days  = new Date(calY,calM+1,0).getDate();
  const mName = new Date(calY,calM).toLocaleString('default',{month:'long',year:'numeric'});
  let h = `<div class="cal-nav"><button onclick="renderCalendar(0,-1)">â€¹</button><span>${mName}</span><button onclick="renderCalendar(0,1)">â€º</button></div>
    <div class="cal-grid">
      ${['Su','Mo','Tu','We','Th','Fr','Sa'].map(d=>`<div class="cal-hd">${d}</div>`).join('')}
      ${'<div></div>'.repeat(first)}`;
  const todayStr = now.toISOString().split('T')[0];
  for(let d=1;d<=days;d++){
    const ds=`${calY}-${String(calM+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const past=ds<todayStr, blocked=blockedDates.includes(ds);
    h+=`<div class="cal-d ${past?'cal-past':blocked?'cal-blocked':'cal-avail'}">${d}</div>`;
  }
  h+=`</div><div class="cal-leg"><span><span class="cldot" style="background:#2ecc71;opacity:.5;"></span>Available</span><span><span class="cldot" style="background:#e74c3c;opacity:.6;"></span>Booked</span></div>`;
  wrap.innerHTML=h;
}

// â”€â”€ WISHLIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function toggleWishlist() {
  if(!getToken()){showModal('loginModal');return;}
  const res = await api('/api/bookings/wishlist/','POST',{property:propId});
  if(res){updateHeartBtn(res.wishlisted);showToast(res.message,'success');}
}
function updateHeartBtn(on) {
  const b=document.getElementById('heartBtn');
  if(b){b.textContent=on?'â¤ï¸':'â™¡';b.classList.toggle('wishlisted',on);}
}

// â”€â”€ GUESTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function changeGuests(d){
  guestCount=Math.max(1,Math.min(propData?propData.max_guests:10,guestCount+d));
  document.getElementById('guestCount').textContent=guestCount;
  updateCalc();
}
function pickCrypto(c,btn){
  selectedCrypto=c;
  document.querySelectorAll('.cpill').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}

// â”€â”€ BOOKING CALC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateCalc(){
  const ci=document.getElementById('checkIn')?.value;
  const co=document.getElementById('checkOut')?.value;
  const sum=document.getElementById('bookSummary');
  const stat=document.getElementById('availStatus');
  const csel=document.getElementById('cryptoSel');
  if(!ci||!co||!propData){sum?.classList.add('hidden');return;}
  const nights=Math.round((new Date(co)-new Date(ci))/86400000);
  if(nights<=0){stat.innerHTML='<span style="color:#e74c3c;">Check-out must be after check-in</span>';sum?.classList.add('hidden');return;}
  let conflict=false;
  for(let d=new Date(ci);d<new Date(co);d.setDate(d.getDate()+1)){
    if(blockedDates.includes(d.toISOString().split('T')[0])){conflict=true;break;}
  }
  if(conflict){
    stat.innerHTML='<span style="color:#e74c3c;">âœ— Dates not available</span>';
    sum?.classList.add('hidden');csel?.classList.add('hidden');return;
  }
  stat.innerHTML='<span style="color:#2ecc71;">âœ“ Available!</span>';
  const total=nights*parseFloat(propData.price_per_night);
  const c=calcCarbon(propData,nights);
  document.getElementById('nightsLbl').textContent=`${nights} night${nights>1?'s':''}`;
  document.getElementById('nightsTot').textContent=`$${total.toFixed(2)}`;
  document.getElementById('bookTotal').textContent=`$${total.toFixed(2)}`;
  document.getElementById('carbonLbl').textContent=`ğŸŒ± ${c.co2*nights}kg COâ‚‚ Â· âš¡ ${c.energy*nights}kWh`;
  document.getElementById('pointsLbl').textContent=`ğŸ† +${parseInt(total)} loyalty points earned`;
  sum?.classList.remove('hidden');csel?.classList.remove('hidden');
}

// â”€â”€ BOOKING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function initiateBooking(pId){
  if(!getToken()){showModal('loginModal');return;}
  const ci=document.getElementById('checkIn')?.value;
  const co=document.getElementById('checkOut')?.value;
  if(!ci||!co){showToast('Select check-in and check-out dates','error');return;}
  const btn=document.getElementById('bookBtn');
  btn.disabled=true;btn.textContent='Processing...';
  const result=await api('/api/bookings/initiate/','POST',{listing:pId,check_in:ci,check_out:co,guests_count:guestCount,currency:selectedCrypto});
  btn.disabled=false;btn.textContent='Reserve Now';
  if(result) showPaymentModal(result);
}

function showPaymentModal(p){
  document.getElementById('payModal')?.remove();
  const m=document.createElement('div');
  m.id='payModal';m.className='modal-overlay';
  m.innerHTML=`
    <div class="modal" style="max-width:460px;">
      <button class="modal-close" onclick="document.getElementById('payModal').remove()">âœ•</button>
      <div class="modal-header"><div style="font-size:2rem;">â‚¿</div><h2>Complete Payment</h2><p>${p.property} Â· ${p.nights} nights Â· $${p.amount_usd}</p></div>
      <div id="pSteps">
        <div class="pstep active" id="ps1">
          <div class="pstep-num">1</div>
          <div>
            <div class="pstep-title">Send ${p.pay_currency}</div>
            <div style="font-size:0.75rem;color:var(--gold);margin-bottom:8px;">${p.network}</div>
            <div class="pay-addr-box"><code>${p.pay_address}</code><button onclick="navigator.clipboard.writeText('${p.pay_address}');showToast('Copied!','success')" class="copy-btn">Copy</button></div>
            <div style="font-size:1.5rem;font-weight:700;text-align:center;margin:8px 0;">${p.pay_amount} <span style="font-size:.9rem;color:var(--text2);">${p.pay_currency}</span></div>
            <div style="font-size:0.75rem;color:var(--text2);text-align:center;">â‰ˆ $${p.amount_usd} USD</div>
          </div>
        </div>
        <div class="pstep" id="ps2"><div class="pstep-num">2</div><div><div class="pstep-title">Verifying on Blockchain</div><div style="color:var(--text2);font-size:.85rem;">Checking transaction...</div><div class="pay-loader"><div></div><div></div><div></div></div></div></div>
        <div class="pstep" id="ps3"><div class="pstep-num">3</div><div><div class="pstep-title">Confirming Booking</div><div style="color:var(--text2);font-size:.85rem;">Reserving your dates...</div></div></div>
        <div class="pstep" id="ps4"><div class="pstep-num" style="background:#2ecc71;">âœ“</div><div><div class="pstep-title" style="color:#2ecc71;">Booking Confirmed! ğŸ‰</div><div style="color:var(--text2);font-size:.85rem;">Host notified & paid instantly. Loyalty points added!</div></div></div>
      </div>
      <div style="margin-top:1.2rem;display:flex;flex-direction:column;gap:8px;">
        <button class="btn-primary w-full" onclick="doPayment('${p.payment_id}')">âœ“ I've Sent the Payment</button>
        <button class="btn-ghost w-full" onclick="document.getElementById('payModal').remove()">Cancel</button>
      </div>
    </div>`;
  document.body.appendChild(m);
}

async function doPayment(pid){
  const steps=['ps1','ps2','ps3'];
  for(let i=0;i<steps.length;i++){
    await new Promise(r=>setTimeout(r,1200));
    document.querySelectorAll('.pstep').forEach(s=>s.classList.remove('active'));
    document.getElementById(steps[i])?.classList.add('done');
    if(i<2) document.getElementById(steps[i+1])?.classList.add('active');
  }
  await new Promise(r=>setTimeout(r,1000));
  document.querySelectorAll('.pstep').forEach(s=>s.classList.remove('active'));
  document.getElementById('ps4')?.classList.add('active');
  const result=await api(`/api/bookings/payment-status/${pid}/`,'POST',{});
  if(result?.booking_created){
    showToast(`ğŸ‰ Booking confirmed! +${result.points_earned||0} loyalty points earned!`,'success');
    setTimeout(()=>{document.getElementById('payModal')?.remove();window.location.href='/bookings';},2500);
  }
}

// â”€â”€ REVIEWS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleReviewForm(){document.getElementById('reviewFormWrap')?.classList.toggle('hidden');}
function setRating(n){
  selectedRating=n;
  document.querySelectorAll('#starPicker span').forEach((s,i)=>{s.textContent=i<n?'â˜…':'â˜†';s.style.color=i<n?'#f59e0b':'var(--text2)';});
}
async function submitReview(){
  if(!selectedRating){showToast('Select a rating','error');return;}
  const comment=document.getElementById('reviewComment').value.trim();
  if(!comment){showToast('Write a comment','error');return;}
  const res=await api('/api/auth/reviews/','POST',{prop:propId,rating:selectedRating,comment});
  if(res){showToast('Review submitted!','success');toggleReviewForm();loadReviews();}
}
async function loadReviews(){
  let data;
  try{const r=await fetch(`/api/auth/reviews/?prop=${propId}`);data=await r.json();}catch(e){data=null;}
  const list=document.getElementById('reviewsList');
  if(!list)return;
  const reviews=data?.results||data||[];
  if(!reviews.length){list.innerHTML='<div style="color:var(--text2);font-size:0.85rem;text-align:center;padding:1.5rem;">No reviews yet â€” be the first!</div>';return;}
  list.innerHTML=reviews.map(r=>`
    <div class="review-item">
      <div class="review-header">
        <div class="rev-av">${(r.reviewer_name||'G')[0].toUpperCase()}</div>
        <div><div class="rev-name">${r.reviewer_name||'Guest'}</div><div class="rev-date">${new Date(r.created_at).toLocaleDateString('en',{month:'short',year:'numeric'})}</div></div>
        <div style="margin-left:auto;color:#f59e0b;font-size:.85rem;">${'â˜…'.repeat(r.rating)}${'â˜†'.repeat(5-r.rating)}</div>
      </div>
      <p style="font-size:.85rem;color:var(--text2);line-height:1.6;margin:0;">${r.comment}</p>
    </div>`).join('');
}

// â”€â”€ CARBON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcCarbon(p,nights=1){
  const f={villa:{co2:18,energy:45,water:320},apartment:{co2:8,energy:15,water:150},house:{co2:14,energy:30,water:220},cabin:{co2:6,energy:12,water:120},studio:{co2:5,energy:10,water:100},penthouse:{co2:22,energy:50,water:380}};
  const t=f[p.property_type]||f['apartment'];
  const m=(p.amenities||[]).includes('pool')?1.4:1;
  return{co2:Math.round(t.co2*m*nights),energy:t.energy*nights,water:t.water*nights,rating:t.co2*m<8?'Low':t.co2*m<16?'Medium':'High'};
}

// â”€â”€ LIGHTBOX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openLightbox(i){lbIndex=i;const lb=document.getElementById('lightbox');document.getElementById('lightboxImg').src=lbImages[i];lb.classList.remove('hidden');document.body.style.overflow='hidden';}
function closeLightbox(){document.getElementById('lightbox').classList.add('hidden');document.body.style.overflow='';}
function lbNav(d,e){e.stopPropagation();lbIndex=(lbIndex+d+lbImages.length)%lbImages.length;document.getElementById('lightboxImg').src=lbImages[lbIndex];}
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeLightbox();if(e.key==='ArrowLeft')lbNav(-1,{stopPropagation:()=>{}});if(e.key==='ArrowRight')lbNav(1,{stopPropagation:()=>{}});});

loadProperty();
</script>
<style>
.prop-gallery{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:2rem;border-radius:16px;overflow:hidden;height:400px;}
.gallery-main{cursor:pointer;overflow:hidden;grid-row:1/3;}
.gallery-main img,.gallery-thumb img{width:100%;height:100%;object-fit:cover;transition:transform .3s;}
.gallery-main:hover img,.gallery-thumb:hover img{transform:scale(1.04);}
.no-img-lg{background:var(--surface2);width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:4rem;}
.gallery-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.gallery-thumb{cursor:pointer;overflow:hidden;position:relative;}
.more-overlay{position:absolute;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;font-size:1.2rem;font-weight:700;}
.prop-layout{display:grid;grid-template-columns:1fr 340px;gap:2.5rem;align-items:start;}
.prop-right{position:sticky;top:84px;}
.prop-header-row{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1rem;}
.prop-type-badge{display:inline-block;background:var(--gold);color:black;font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;padding:3px 10px;border-radius:20px;margin-bottom:8px;}
.prop-title{font-size:1.75rem;margin-bottom:8px;font-family:'Playfair Display',serif;}
.prop-meta-row{display:flex;gap:1rem;flex-wrap:wrap;font-size:.82rem;color:var(--text2);}
.heart-btn{background:none;border:1px solid var(--border);border-radius:50%;width:42px;height:42px;font-size:1.2rem;cursor:pointer;transition:all .2s;flex-shrink:0;}
.heart-btn:hover,.heart-btn.wishlisted{border-color:var(--gold);transform:scale(1.1);}
.prop-specs-row{display:flex;gap:1.5rem;flex-wrap:wrap;padding:1rem 0;border-top:1px solid var(--border);border-bottom:1px solid var(--border);margin-bottom:1.5rem;font-size:.88rem;}
.prop-section{margin-bottom:1.8rem;}
.prop-section h3{font-size:.76rem;text-transform:uppercase;letter-spacing:.06em;color:var(--gold);margin-bottom:.9rem;}
.amenities-wrap{display:flex;flex-wrap:wrap;gap:8px;}
.amenity-chip{background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:5px 14px;font-size:.82rem;}
.carbon-box{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:1rem;}
.carbon-rating{font-size:.78rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;margin-bottom:.75rem;}
.carbon-low{color:#2ecc71;}.carbon-medium{color:#f59e0b;}.carbon-high{color:#e74c3c;}
.carbon-stats{display:flex;gap:1.5rem;}
.carbon-stat{display:flex;flex-direction:column;align-items:center;gap:2px;font-size:.76rem;color:var(--text2);}
.carbon-stat strong{font-size:.95rem;color:var(--text);}
.cal-nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem;}
.cal-nav button{background:none;border:1px solid var(--border);color:var(--text);border-radius:8px;width:30px;height:30px;cursor:pointer;font-size:1rem;}
.cal-nav span{font-weight:600;font-size:.9rem;}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;}
.cal-hd{text-align:center;font-size:.65rem;color:var(--text2);padding:4px 0;text-transform:uppercase;}
.cal-d{text-align:center;padding:5px 2px;border-radius:6px;font-size:.8rem;}
.cal-avail{color:var(--text2);}
.cal-blocked{background:rgba(231,76,60,.15);color:#e74c3c;text-decoration:line-through;}
.cal-past{opacity:.3;}
.cal-leg{display:flex;gap:1rem;margin-top:.75rem;font-size:.73rem;color:var(--text2);}
.cldot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:4px;}
.booking-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r2);padding:1.4rem;box-shadow:0 8px 32px rgba(0,0,0,.3);}
.booking-price{font-size:1.75rem;font-weight:700;margin-bottom:1rem;}
.booking-price-night{font-size:.85rem;color:var(--text2);font-weight:400;}
.date-inputs{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:.9rem;}
.date-inp-group label{display:block;font-size:.62rem;color:var(--text2);text-transform:uppercase;letter-spacing:.07em;margin-bottom:3px;}
.date-inp-group input{width:100%;font-size:.83rem;}
.guests-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:.8rem;}
.guests-counter{display:flex;align-items:center;gap:10px;}
.guests-counter button{background:var(--surface2);border:1px solid var(--border);color:var(--text);width:26px;height:26px;border-radius:50%;cursor:pointer;font-size:1rem;}
.b-line{display:flex;justify-content:space-between;font-size:.85rem;margin-bottom:5px;}
.crypto-pills-row{display:flex;flex-wrap:wrap;gap:5px;}
.cpill{background:var(--surface2);border:1px solid var(--border);color:var(--text2);border-radius:20px;padding:3px 9px;font-size:.7rem;font-weight:700;cursor:pointer;transition:all .15s;}
.cpill.active{background:var(--gold);color:black;border-color:var(--gold);}
.review-item{padding:.9rem 0;border-bottom:1px solid rgba(255,255,255,.05);}
.review-item:last-child{border-bottom:none;}
.review-header{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
.rev-av{width:34px;height:34px;border-radius:50%;background:var(--gold);color:black;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.85rem;flex-shrink:0;}
.rev-name{font-size:.86rem;font-weight:600;}
.rev-date{font-size:.73rem;color:var(--text2);}
.pstep{display:none;gap:12px;padding:.8rem 0;}
.pstep.active{display:flex;align-items:flex-start;}
.pstep-num{width:26px;height:26px;border-radius:50%;background:var(--gold);color:black;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.8rem;flex-shrink:0;margin-top:2px;}
.pstep.done .pstep-num{background:#2ecc71;}
.pstep-title{font-weight:700;margin-bottom:5px;}
.pay-addr-box{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:7px 10px;display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px;}
.pay-addr-box code{font-size:.68rem;word-break:break-all;flex:1;}
.copy-btn{background:var(--gold);color:black;border:none;border-radius:6px;padding:3px 9px;font-size:.7rem;font-weight:700;cursor:pointer;white-space:nowrap;}
.pay-loader{display:flex;gap:6px;justify-content:center;margin-top:.9rem;}
.pay-loader div{width:8px;height:8px;border-radius:50%;background:var(--gold);animation:pb 1.4s infinite ease-in-out;}
.pay-loader div:nth-child(2){animation-delay:.2s;}
.pay-loader div:nth-child(3){animation-delay:.4s;}
@keyframes pb{0%,80%,100%{transform:scale(.6);opacity:.4}40%{transform:scale(1);opacity:1}}
.lightbox{position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:9999;display:flex;align-items:center;justify-content:center;}
.lightbox img{max-width:90vw;max-height:90vh;border-radius:8px;object-fit:contain;}
.lb-close{position:fixed;top:20px;right:24px;background:rgba(255,255,255,.15);border:none;color:white;font-size:1.1rem;width:36px;height:36px;border-radius:50%;cursor:pointer;}
.lb-prev,.lb-next{position:fixed;top:50%;transform:translateY(-50%);background:rgba(255,255,255,.12);border:none;color:white;font-size:2rem;width:46px;height:46px;border-radius:50%;cursor:pointer;}
.lb-prev{left:14px;}.lb-next{right:14px;}
@media(max-width:900px){.prop-layout{grid-template-columns:1fr;}.prop-right{position:static;}.prop-gallery{height:280px;}}
@media(max-width:600px){.prop-gallery{grid-template-columns:1fr;height:220px;}.gallery-grid{display:none;}}
</style>
{% endblock %}