{% extends 'base.html' %}
{% block title %}Profile ‚Äî Voyaga{% endblock %}
{% block content %}

<div class="page-container">
  <div class="profile-wrap">

    <div class="profile-header">
      <div class="profile-avatar-big" id="profileAvatar">?</div>
      <div>
        <h1 class="profile-name" id="profileName">Loading...</h1>
        <p class="profile-role" id="profileRole"></p>
        <p class="profile-email" id="profileEmail"></p>
      </div>
    </div>

    <div class="profile-body">

      <div class="profile-section">
        <h3>Edit Profile</h3>
        <form id="profileForm" onsubmit="saveProfile(event)">
          <div class="form-row">
            <div class="form-group">
              <label>First Name</label>
              <input type="text" id="pfFirst" placeholder="First name">
            </div>
            <div class="form-group">
              <label>Last Name</label>
              <input type="text" id="pfLast" placeholder="Last name">
            </div>
          </div>
          <div class="form-group">
            <label>Phone</label>
            <input type="text" id="pfPhone" placeholder="+91 98765 43210">
          </div>
          <div class="form-group">
            <label>Bio</label>
            <textarea id="pfBio" rows="3" placeholder="Tell us about yourself..."></textarea>
          </div>
          <div id="profileMsg" class="form-success hidden"></div>
          <button type="submit" class="btn-primary" id="saveBtn">Save Changes</button>
        </form>
      </div>

      <div class="profile-section">
        <h3>Wallet</h3>
        <div class="wallet-card">
          <div class="wallet-bal-label">Current Balance</div>
          <div class="wallet-bal-amount" id="profileWallet">$0.00</div>
        </div>

        

        <div class="withdraw-section">
  <p class="tab-desc">Withdraw your balance to a crypto wallet ‚Äî funds are sent within 24 hours.</p>

  <div class="form-group">
    <label>Withdraw Amount (USD)</label>
    <div class="topup-amounts">
      <button onclick="setWithdrawAmount(50)">$50</button>
      <button onclick="setWithdrawAmount(100)">$100</button>
      <button onclick="setWithdrawAmount(250)">$250</button>
      <button onclick="setWithdrawAmount(500)">$500</button>
    </div>
    <div class="topup-custom" style="margin-top:8px;">
      <input type="number" id="withdrawAmount" placeholder="Custom USD amount" min="10">
    </div>
  </div>

  <div class="form-group">
    <label>Select Cryptocurrency</label>
    <select id="withdrawCurrency">
      <option value="btc">Bitcoin (BTC)</option>
      <option value="eth">Ethereum (ETH)</option>
      <option value="usdt">Tether USDT ‚Äî TRC20</option>
      <option value="ltc">Litecoin (LTC)</option>
      <option value="bnb">BNB Smart Chain</option>
      <option value="sol">Solana (SOL)</option>
      <option value="doge">Dogecoin (DOGE)</option>
    </select>
  </div>

  <div class="form-group">
    <label>Your Wallet Address</label>
    <input type="text" id="withdrawAddress" placeholder="Enter your crypto wallet address">
  </div>

  <div class="withdraw-note">
    <span>‚ö†Ô∏è</span>
    <span>Double-check your wallet address. Withdrawals cannot be reversed once processed.</span>
  </div>

  <button class="btn-primary w-full" onclick="submitWithdraw()" id="withdrawBtn">
    Withdraw Funds
  </button>

  <div id="withdrawResult" class="hidden"></div>
</div>
      </div>

      <div class="profile-section">
        <h3>Transaction History</h3>
        <div id="transactionList">Loading...</div>
      </div>

    </div>
  </div>
</div>

<style>
  .withdraw-section { display: flex; flex-direction: column; gap: 1rem; }
.withdraw-note { display: flex; gap: 8px; align-items: flex-start; background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px; font-size: 0.78rem; color: var(--text2); line-height: 1.5; }
.profile-wrap { max-width: 800px; margin: 0 auto; padding-top: 2rem; }
.profile-header { display: flex; align-items: center; gap: 1.5rem; margin-bottom: 2rem; padding: 2rem; background: var(--surface); border: 1px solid var(--border); border-radius: var(--r2); }
.profile-avatar-big { width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--gold)); display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 700; color: white; flex-shrink: 0; }
.profile-name { font-size: 1.6rem; margin-bottom: 4px; }
.profile-role { color: var(--gold); font-size: 0.85rem; text-transform: capitalize; margin-bottom: 2px; }
.profile-email { color: var(--text2); font-size: 0.88rem; }
.profile-body { display: flex; flex-direction: column; gap: 1.5rem; margin-bottom: 3rem; }
.profile-section { background: var(--surface); border: 1px solid var(--border); border-radius: var(--r2); padding: 1.5rem; }
.profile-section h3 { font-size: 1rem; margin-bottom: 1.2rem; }
.wallet-card { text-align: center; padding: 1rem 0 1.5rem; }
.wallet-bal-label { font-size: 0.78rem; color: var(--text2); text-transform: uppercase; letter-spacing: 0.08em; }
.wallet-bal-amount { font-size: 2.8rem; font-family: 'Playfair Display', serif; color: var(--gold); margin: 0.25rem 0; }
.topup-tabs { display: flex; gap: 6px; margin-bottom: 1.2rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem; }
.topup-tab { background: var(--surface2); border: 1px solid var(--border); color: var(--text2); padding: 7px 16px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; font-family: 'DM Sans', sans-serif; transition: all 0.2s; }
.topup-tab.active { background: var(--gold-glow); border-color: var(--gold); color: var(--gold); }
.topup-tab-content { animation: fadeIn 0.2s ease; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.tab-desc { color: var(--text2); font-size: 0.85rem; margin-bottom: 1rem; }
.tab-note { color: var(--text2); font-size: 0.78rem; margin-top: 0.75rem; line-height: 1.5; }
.topup-amounts { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 1rem; }
.topup-amounts button { background: var(--surface2); border: 1px solid var(--border); color: var(--text2); padding: 8px 16px; border-radius: 20px; cursor: pointer; font-family: 'DM Sans', sans-serif; transition: all 0.2s; }
.topup-amounts button:hover { border-color: var(--gold); color: var(--gold); }
.topup-custom { display: flex; gap: 8px; }
.topup-custom input { flex: 1; background: var(--bg2); border: 1px solid var(--border); color: var(--text); padding: 9px 12px; border-radius: 10px; font-family: 'DM Sans', sans-serif; font-size: 0.88rem; outline: none; }
.topup-custom input:focus { border-color: var(--gold); }
.crypto-payment-box { background: var(--bg2); border: 1px solid var(--border2); border-radius: 12px; padding: 1.2rem; margin-top: 1rem; }
.cpb-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
.cpb-status { font-size: 0.88rem; font-weight: 500; }
.cpb-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; font-size: 0.85rem; }
.cpb-label { color: var(--text2); }
.cpb-val { font-weight: 600; color: var(--gold); }
.cpb-address { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 10px 12px; font-family: monospace; font-size: 0.78rem; word-break: break-all; color: var(--text2); cursor: pointer; margin: 6px 0; }
.copy-btn { background: var(--surface2); border: 1px solid var(--border); color: var(--text2); padding: 6px 14px; border-radius: 16px; font-size: 0.78rem; cursor: pointer; width: 100%; margin-top: 4px; font-family: 'DM Sans', sans-serif; transition: all 0.2s; }
.copy-btn:hover { border-color: var(--gold); color: var(--gold); }
.tx-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 0.85rem; }
.tx-row:last-child { border-bottom: none; }
.tx-desc { color: var(--text2); flex: 1; }
.tx-date { color: var(--text2); font-size: 0.75rem; margin: 0 1rem; white-space: nowrap; }
.tx-amount { font-weight: 600; white-space: nowrap; }
.tx-amount.positive { color: var(--green); }
.tx-amount.negative { color: var(--red); }
</style>

{% endblock %}
{% block scripts %}
<script>
  function setWithdrawAmount(amount) {
  document.getElementById('withdrawAmount').value = amount;
}

async function submitWithdraw() {
  const amount = parseFloat(document.getElementById('withdrawAmount').value);
  const currency = document.getElementById('withdrawCurrency').value;
  const address = document.getElementById('withdrawAddress').value.trim();

  if (!amount || amount < 10) { showToast('Minimum withdrawal is $10', 'error'); return; }
  if (!address) { showToast('Enter your wallet address', 'error'); return; }

  const wallet = await api('/api/payments/wallet/');
  if (!wallet) return;

  if (amount > parseFloat(wallet.balance)) {
    showToast(`Insufficient balance. Available: $${parseFloat(wallet.balance).toFixed(2)}`, 'error');
    return;
  }

  const btn = document.getElementById('withdrawBtn');
  btn.disabled = true;
  btn.textContent = 'Processing...';

  const result = await api('/api/payments/withdraw/', 'POST', {
    amount, currency, address
  });

  btn.disabled = false;
  btn.textContent = 'Withdraw Funds';

  if (result) {
    const box = document.getElementById('withdrawResult');
    box.innerHTML = `
      <div style="background:var(--surface);border:1px solid var(--green);border-radius:12px;padding:1rem;margin-top:0.5rem;">
        <div style="font-weight:700;margin-bottom:6px;color:var(--green);">‚úì Withdrawal Requested</div>
        <div style="font-size:0.84rem;color:var(--text2);line-height:1.7;">
          <div>Amount: <strong style="color:var(--text);">$${amount.toFixed(2)}</strong></div>
          <div>Currency: <strong style="color:var(--text);">${currency.toUpperCase()}</strong></div>
          <div>To: <span style="font-family:monospace;font-size:0.76rem;">${address}</span></div>
          <div style="margin-top:6px;">Reference: <strong style="color:var(--gold);">${result.reference}</strong></div>
          <div style="margin-top:4px;font-size:0.76rem;">Processed within 24 hours.</div>
        </div>
      </div>`;
    box.classList.remove('hidden');
    updateWalletDisplay(result.new_balance);
    document.getElementById('withdrawAmount').value = '';
    document.getElementById('withdrawAddress').value = '';
    loadProfile();
  }
}
let currentPaymentId = null;
let statusCheckInterval = null;

async function loadProfile() {
  if (!getToken()) { window.location.href = '/'; return; }

  const [user, wallet, txData] = await Promise.all([
    api('/api/auth/profile/'),
    api('/api/payments/wallet/'),
    api('/api/payments/transactions/')
  ]);

  if (user) {
    document.getElementById('profileAvatar').textContent = (user.first_name?.[0] || user.email[0]).toUpperCase();
    document.getElementById('profileName').textContent = `${user.first_name} ${user.last_name}`.trim() || user.username;
    document.getElementById('profileRole').textContent = '‚ú¶ ' + user.role;
    document.getElementById('profileEmail').textContent = user.email;
    document.getElementById('pfFirst').value = user.first_name || '';
    document.getElementById('pfLast').value = user.last_name || '';
    document.getElementById('pfPhone').value = user.phone || '';
    document.getElementById('pfBio').value = user.bio || '';
  }

  if (wallet) {
    updateWalletDisplay(wallet.balance);
  }

  if (txData && txData.results) {
    const list = document.getElementById('transactionList');
    if (!txData.results.length) {
      list.innerHTML = '<p class="empty-state">No transactions yet.</p>';
    } else {
      list.innerHTML = txData.results.slice(0, 15).map(t => {
        const amt = parseFloat(t.amount);
        return `
          <div class="tx-row">
            <span class="tx-desc">${t.description}</span>
            <span class="tx-date">${new Date(t.created_at).toLocaleDateString()}</span>
            <span class="tx-amount ${amt >= 0 ? 'positive' : 'negative'}">
              ${amt >= 0 ? '+' : ''}$${Math.abs(amt).toFixed(2)}
            </span>
          </div>`;
      }).join('');
    }
  }
}

function updateWalletDisplay(balance) {
  const formatted = '$' + parseFloat(balance).toFixed(2);
  const profileEl = document.getElementById('profileWallet');
  const navEl = document.getElementById('walletAmount');
  if (profileEl) profileEl.textContent = formatted;
  if (navEl) navEl.textContent = formatted;
  const user = getUser();
  if (user) {
    user.wallet_balance = balance;
    localStorage.setItem('voyaga_user', JSON.stringify(user));
  }
}

function switchTab(name, btn) {
  document.querySelectorAll('.topup-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.topup-tab-content').forEach(t => t.classList.add('hidden'));
  btn.classList.add('active');
  document.getElementById('tab-' + name).classList.remove('hidden');
}

async function quickTopup(amount) {
  if (!amount || isNaN(amount) || amount <= 0) { showToast('Enter a valid amount', 'error'); return; }
  const result = await api('/api/payments/wallet/topup/', 'POST', { amount: parseFloat(amount) });
  if (result) {
    updateWalletDisplay(result.new_balance);
    showToast(result.message, 'success');
    loadProfile();
  }
}

function setNowAmount(amount) {
  document.getElementById('nowAmount').value = amount;
}

async function createNowPayment() {
  const amount = parseFloat(document.getElementById('nowAmount').value);
  const currency = document.getElementById('nowCurrency').value;

  if (!amount || amount <= 0) { showToast('Enter a valid USD amount', 'error'); return; }

  const btn = document.getElementById('nowPayBtn');
  btn.disabled = true;
  btn.textContent = 'Creating payment...';

  const result = await api('/api/payments/nowpayments/create/', 'POST', { amount, currency });

  btn.disabled = false;
  btn.textContent = 'Generate Payment Address';

  if (!result) return;

  currentPaymentId = result.payment_id;

  document.getElementById('nowPayAmount').textContent = `${result.pay_amount} ${result.pay_currency?.toUpperCase()}`;
  document.getElementById('nowPayAddress').textContent = result.pay_address;
  document.getElementById('nowUsdAmount').textContent = `$${amount.toFixed(2)}`;
  document.getElementById('nowStatus').textContent = '‚è≥ Waiting for payment...';
  document.getElementById('nowPaymentBox').classList.remove('hidden');

  if (statusCheckInterval) clearInterval(statusCheckInterval);
  statusCheckInterval = setInterval(checkNowStatus, 30000);
}

async function checkNowStatus() {
  if (!currentPaymentId) return;

  const result = await api(`/api/payments/nowpayments/status/${currentPaymentId}/`);
  if (!result) return;

  const statusEl = document.getElementById('nowStatus');
  const statusMap = {
    waiting: '‚è≥ Waiting for payment...',
    confirming: 'üîÑ Confirming on blockchain...',
    confirmed: '‚úÖ Confirmed!',
    finished: '‚úÖ Payment complete!',
    failed: '‚ùå Payment failed',
    expired: '‚åõ Payment expired',
    partially_paid: '‚ö†Ô∏è Partially paid'
  };

  statusEl.textContent = statusMap[result.status] || result.status;

  if (result.credited) {
    clearInterval(statusCheckInterval);
    statusCheckInterval = null;
    updateWalletDisplay(result.new_balance);
    showToast(`$${result.amount} added to your wallet!`, 'success');
    setTimeout(() => {
      document.getElementById('nowPaymentBox').classList.add('hidden');
      currentPaymentId = null;
      loadProfile();
    }, 2000);
  }
}

function copyNowAddr() {
  const addr = document.getElementById('nowPayAddress').textContent.trim();
  navigator.clipboard.writeText(addr);
  showToast('Address copied!', 'success');
}

async function saveProfile(e) {
  e.preventDefault();
  const btn = document.getElementById('saveBtn');
  btn.disabled = true;
  btn.textContent = 'Saving...';

  const result = await api('/api/auth/profile/', 'PATCH', {
    first_name: document.getElementById('pfFirst').value,
    last_name: document.getElementById('pfLast').value,
    phone: document.getElementById('pfPhone').value,
    bio: document.getElementById('pfBio').value,
  });

  btn.disabled = false;
  btn.textContent = 'Save Changes';

  if (result) {
    localStorage.setItem('voyaga_user', JSON.stringify(result));
    const msg = document.getElementById('profileMsg');
    msg.textContent = 'Profile updated successfully!';
    msg.classList.remove('hidden');
    setTimeout(() => msg.classList.add('hidden'), 3000);
    showToast('Profile saved!', 'success');
  }
}

loadProfile();
</script>
{% endblock %}