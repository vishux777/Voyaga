{% extends 'base.html' %}
{% block title %}Dashboard â€” Voyaga{% endblock %}
{% block content %}

<div class="dashboard-layout">
  <aside class="dash-sidebar">
    <nav class="dash-nav">
      <a href="/dashboard" class="dash-link active">
        <span>â¬¡</span> Overview
      </a>
      <a href="/bookings" class="dash-link">
        <span>ğŸ“‹</span> My Bookings
      </a>
      <a href="/profile" class="dash-link">
        <span>ğŸ‘¤</span> Profile
      </a>
      <a href="/list-property" class="dash-link">
        <span>ğŸ </span> List Property
      </a>
      <div id="hostLinks" class="hidden">
        <div class="dash-divider">Host Tools</div>
        <a href="/host/listings" class="dash-link">
          <span>ğŸ“‘</span> My Listings
        </a>
        <a href="/host/bookings" class="dash-link">
          <span>ğŸ—“ï¸</span> Guest Bookings
        </a>
      </div>
    </nav>
  </aside>

  <div class="dash-content" id="dashContent">
    <div class="dash-welcome">

      <div class="dash-top">
        <div>
          <h1 class="dash-greeting">Welcome back, <span id="dashUserName">Traveler</span> âœ¦</h1>
          <p class="dash-sub" id="dashRole"></p>
        </div>
        <a href="/list-property" class="btn-primary" style="white-space:nowrap;align-self:center;">
          + List Property
        </a>
      </div>

      <div class="dash-cards">
        <div class="dash-card">
          <div class="dash-card-icon">âœˆï¸</div>
          <div class="dash-card-val" id="bookingCount">â€”</div>
          <div class="dash-card-label">Total Bookings</div>
        </div>
        <div class="dash-card">
          <div class="dash-card-icon">â­</div>
          <div class="dash-card-val" id="reviewCount">â€”</div>
          <div class="dash-card-label">Reviews Given</div>
        </div>
        <div class="dash-card" id="hostEarningsCard" style="display:none;">
          <div class="dash-card-icon">ğŸ’°</div>
          <div class="dash-card-val" id="hostEarnings">â€”</div>
          <div class="dash-card-label">Host Earnings</div>
        </div>
        <div class="dash-card" id="listingsCard" style="display:none;">
          <div class="dash-card-icon">ğŸ </div>
          <div class="dash-card-val" id="listingsCount">â€”</div>
          <div class="dash-card-label">My Listings</div>
        </div>
      </div>

      <div class="recent-section">
        <div class="recent-header">
          <h3>Recent Bookings</h3>
          <a href="/bookings" class="view-all-link">View all â†’</a>
        </div>
        <div id="recentBookings">Loading...</div>
      </div>

      <div id="hostSection" class="hidden">
        <div class="recent-section" style="margin-top:1.5rem;">
          <div class="recent-header">
            <h3>Guest Bookings at Your Properties</h3>
          </div>
          <div id="hostBookingsList">Loading...</div>
        </div>
      </div>

    </div>
  </div>
</div>

<style>
.dash-top { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:2rem; flex-wrap:wrap; gap:1rem; }
.dash-greeting { font-size:1.8rem; margin-bottom:4px; }
.dash-sub { color:var(--text2); font-size:0.88rem; }
.recent-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; }
.recent-header h3 { font-size:1rem; }
.view-all-link { font-size:0.82rem; color:var(--gold); text-decoration:none; }
.view-all-link:hover { text-decoration:underline; }
</style>

{% endblock %}
{% block scripts %}
<script>
async function loadDashboard() {
  if (!getToken()) { window.location.href = '/'; return; }

  const user = getUser();
  if (!user) { window.location.href = '/'; return; }

  document.getElementById('dashUserName').textContent = user.first_name || user.username || 'Traveler';
  document.getElementById('dashRole').textContent = 'âœ¦ ' + (user.role || 'guest');

  if (user.role === 'host') {
    document.getElementById('hostLinks').classList.remove('hidden');
    document.getElementById('hostEarningsCard').style.display = 'block';
    document.getElementById('listingsCard').style.display = 'block';
    document.getElementById('hostSection').classList.remove('hidden');
  }

  const [bookings, hostBookings, myProps] = await Promise.all([
    api('/api/bookings/'),
    user.role === 'host' ? api('/api/bookings/host/') : Promise.resolve(null),
    user.role === 'host' ? api('/api/properties/my/') : Promise.resolve(null),
  ]);

  if (bookings) {
    document.getElementById('bookingCount').textContent = bookings.count || 0;

    const reviews = (bookings.results || []).filter(b => b.status === 'completed').length;
    document.getElementById('reviewCount').textContent = reviews;

    const recent = (bookings.results || []).slice(0, 4);
    document.getElementById('recentBookings').innerHTML = recent.length
      ? recent.map(b => `
          <div class="booking-row">
            <div class="booking-prop">${b.property_detail?.title || 'Property'}</div>
            <div class="booking-dates">${b.check_in} â†’ ${b.check_out}</div>
            <div class="booking-amount">$${parseFloat(b.total_price).toFixed(2)}</div>
            <span class="status-badge ${b.status}">${b.status}</span>
          </div>`).join('')
      : '<p class="empty-state">No bookings yet. <a href="/properties">Explore stays â†’</a></p>';
  }

  if (myProps && myProps.results) {
    document.getElementById('listingsCount').textContent = myProps.results.length;
  }

  if (hostBookings && hostBookings.results) {
    const earnings = hostBookings.results
      .filter(b => b.status === 'completed')
      .reduce((sum, b) => sum + parseFloat(b.total_price) * 0.97, 0);
    document.getElementById('hostEarnings').textContent = '$' + earnings.toFixed(2);

    const list = hostBookings.results.slice(0, 4);
    document.getElementById('hostBookingsList').innerHTML = list.length
      ? list.map(b => `
          <div class="booking-row">
            <div class="booking-prop">${b.property_detail?.title || 'Property'}</div>
            <div class="booking-dates">${b.check_in} â†’ ${b.check_out}</div>
            <div class="booking-amount">$${parseFloat(b.total_price).toFixed(2)}</div>
            <span class="status-badge ${b.status}">${b.status}</span>
          </div>`).join('')
      : '<p class="empty-state">No guest bookings yet.</p>';
  }
}

loadDashboard();
</script>
{% endblock %}